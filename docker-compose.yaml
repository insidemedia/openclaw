services:
  openclaw:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw
    restart: always
    user: "root"

    environment:
      - NODE_ENV=production
      - OPENCLAW_CONFIG=/root/.openclaw/config/openclaw.json
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENCLAW_TOKEN=${OPENCLAW_TOKEN}

    volumes:
      - openclaw-data:/root/.openclaw
      - openclaw-workspace:/workspace
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      # Map standard port 3000
      - "3000:3000"

    # THE SCRIPT:
    # 1. Deletes old config (rm -rf)
    # 2. Writes new config with "allowInsecureAuth": true
    # 3. Starts the agent
    command: >
      sh -c " rm -rf /root/.openclaw/config/openclaw.json && mkdir -p /root/.openclaw/config && echo '{\"general\":{\"workspacePath\":\"/workspace\",\"expertMode\":true,\"timezone\":\"America/Chicago\"},\"gateway\":{\"bind\":\"0.0.0.0\",\"controlUi\":{\"allowInsecureAuth\":true},\"auth\":{\"mode\":\"token\",\"token\":\"'$OPENCLAW_TOKEN'\"}},\"server\":{\"port\":3000},\"model\":{\"primary\":\"google/gemini-1.5-flash-latest\",\"apiKey\":\"'$GEMINI_API_KEY'\"}}' > /root/.openclaw/config/openclaw.json && node dist/index.js gateway "

volumes:
  openclaw-data:
  openclaw-workspace:
