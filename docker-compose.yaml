services:
  openclaw:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw
    restart: always
    user: "root"

    environment:
      - NODE_ENV=production
      - OPENCLAW_CONFIG=/root/.openclaw/config/openclaw.json
      # Pass your variables
      - GEMINI_API_KEY=${GEMINI_API_KEY}

      - OPENCLAW_TOKEN=${OPENCLAW_TOKEN}
    volumes:
      # Keep persistent data
      - openclaw-data:/root/.openclaw
      - openclaw-workspace:/workspace
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "3000:3000"

    # THE FIX: Added 'rm -rf' to delete the bad directory before writing the file
    command: >
      sh -c " rm -rf /root/.openclaw/config/openclaw.json && mkdir -p /root/.openclaw/config && echo '{\"general\":{\"workspacePath\":\"/workspace\",\"expertMode\":true,\"timezone\":\"America/Chicago\"},\"gateway\":{\"bind\":\"0.0.0.0\",\"auth\":{\"mode\":\"token\",\"token\":\"'$OPENCLAW_TOKEN'\"}},\"server\":{\"port\":3000},\"model\":{\"primary\":\"google/gemini-1.5-flash-latest\",\"apiKey\":\"'$GEMINI_API_KEY'\"}}' > /root/.openclaw/config/openclaw.json && node dist/index.js gateway "

volumes:
  openclaw-data:
  openclaw-workspace:
